name: Deploy

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  test:
    name: Test pipeline
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: [ '1.22' ]

    env:
      MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
      MYSQL_PORT: ${{ secrets.MYSQL_PORT }}
      MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
      MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
      REDIS_HOST: ${{ secrets.REDIS_HOST }}
      REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      ALGOLIA_APP_ID: ${{ secrets.ALGOLIA_APP_ID }}
      ALGOLIA_API_KEY: ${{ secrets.ALGOLIA_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: ${{ matrix.go-version }}

      - name: Cache Go Modules
        uses: actions/cache@v2
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.go-version }}-

      - name: Create configuration yaml file
        run: |
          cat <<EOF > config.yml
          app:
            server:
              host: "localhost"
              port: "8080"
              timeout:
                server: 30
                read: 15
                write: 10
                idle: 5
            mysql:
              host: "${{ env.MYSQL_HOST }}"
              port: "${{ env.MYSQL_PORT }}"
              username: "${{ env.MYSQL_USERNAME }}"
              password: "${{ secrets.MYSQL_PASSWORD }}"
              database: "${{ secrets.MYSQL_DATABASE }}"
            redis:
              host: "${{ env.REDIS_HOST }}"
              port: "6379"
              password: "${{ secrets.REDIS_PASSWORD }}"
              db: 0
            algolia:
              appID: "${{ env.ALGOLIA_APP_ID }}"
              apiKey: "${{ env.ALGOLIA_API_KEY }}"
          EOF

      - name: Create .env file
        run: |
          cat <<EOF > ./files/env/.env
          SCHEDULER_UPDATE_BOOK_STATUS="@daily"
          SCHEDULER_REFRESH_CACHE_REDIS="@hourly"
          SCHEDULER_LOG_TEST="*/10 * * * * *"
          EOF

      - name: Install Mockery
        run: |
          go install github.com/vektra/mockery/v2/...@v2.43.1

      - name: Execute unit test
        run: |
          mockery --all --keeptree
          go test -coverprofile=coverage.out ./... ; go tool cover -html=coverage.out

      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage.out

  build:
    name: Build App
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.22'

      - name: Build the app
        run: |
          go mod tidy
          go build -o bin/library_app/http ./cmd/library_app/http/main.go

      - name: Zip the build
        run: |
          zip deployment.zip bin/library_app/http config.yml

      - name: Upload Deployment Package
        uses: actions/upload-artifact@v3
        with:
          name: deployment-package
          path: deployment.zip

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
      EC2_PUBLIC_IP: ${{ secrets.EC2_PUBLIC_IP }}

    steps:
      - name: Download Deployment Package
        uses: actions/download-artifact@v3
        with:
          name: deployment-package
          path: .

      - name: Install AWS CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y awscli

      - name: Send SSH Key
        run: |
          aws ec2-instance-connect send-ssh-public-key \
            --instance-id $EC2_INSTANCE_ID \
            --availability-zone us-west-2a \
            --instance-os-user ec2-user \
            --ssh-public-key file://path-to-your-public-key.pub

      - name: Deploy to EC2
        run: |
          scp -i /path-to-your-private-key.pem deployment.zip ec2-user@$EC2_PUBLIC_IP:~
          ssh -i /path-to-your-private-key.pem ec2-user@$EC2_PUBLIC_IP << 'EOF'
            unzip -o deployment.zip -d ~/app
            cd ~/app
            nohup ./library_app --config config.yml &
          EOF

      - name: Cleanup
        run: rm -f deployment.zip
